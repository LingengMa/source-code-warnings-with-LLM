# C/C++ Semantic Slicer

å•æ–‡ä»¶ã€å¤šå‡½æ•°çº§åˆ«çš„ C/C++ è¯­ä¹‰åˆ‡ç‰‡å·¥å…·ã€‚åŸºäº tree-sitter å®ç°é™æ€ç¨‹åºåˆ†æï¼Œæå–è¯­ä¹‰é”šç‚¹å¹¶æ‰§è¡Œå‰å‘/åå‘åˆ‡ç‰‡ã€‚

## ç‰ˆæœ¬ä¿¡æ¯

**å½“å‰ç‰ˆæœ¬**: v4.0 (2025-12-19)

**ä¸»è¦æ›´æ–°**ï¼š
- âœ¨ å¢å¼ºçš„æŒ‡é’ˆåˆ«ååˆ†æï¼ˆä¼ é€’æ€§ã€å¤šå±‚æŒ‡é’ˆã€ç»“æ„ä½“å­—æ®µï¼‰
- âœ¨ å‡½æ•°å‰¯ä½œç”¨åˆ†æï¼ˆæŒ‡é’ˆå‚æ•°ä¿®æ”¹è¿½è¸ªï¼‰
- âœ¨ é€’å½’è°ƒç”¨æ£€æµ‹å’Œå¤„ç†
- âœ¨ ç±»å‹ä¿¡æ¯æå–ç³»ç»Ÿ
- âœ¨ æ•°ç»„è®¿é—®è¿½è¸ª
- ğŸ”§ æ”¹è¿›çš„å·¦å€¼æå–å’Œå˜é‡åŒ¹é…

è¯¦è§ [RELEASE_v4.0.md](RELEASE_v4.0.md)

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **è¯­ä¹‰é”šç‚¹è¯†åˆ«**: è‡ªåŠ¨æå–ç›®æ ‡è¡Œçš„å˜é‡å®šä¹‰ã€èµ‹å€¼ã€å‡½æ•°è°ƒç”¨ç­‰è¯­ä¹‰é”šç‚¹
- **ä½œç”¨åŸŸåˆ†æ**: åŒºåˆ†å…¨å±€å˜é‡ã€å‡½æ•°å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼Œé¿å…è·¨å‡½æ•°è¯¯æŠ¥
- **æ•°æ®ä¾èµ–åˆ†æ**: æ„å»ºæ–‡ä»¶çº§çš„ def-use é“¾ï¼Œè¿½è¸ªå˜é‡çš„å®šä¹‰å’Œä½¿ç”¨
- **æ§åˆ¶ä¾èµ–åˆ†æ**: è¯†åˆ«æ§åˆ¶æµè¯­å¥ï¼ˆif/while/forï¼‰å¯¹è¯­å¥çš„æ§åˆ¶ä¾èµ–å…³ç³»
- **åŒå‘åˆ‡ç‰‡**: æ”¯æŒå‰å‘åˆ‡ç‰‡ï¼ˆå½±å“åˆ†æï¼‰å’Œåå‘åˆ‡ç‰‡ï¼ˆæº¯æºåˆ†æï¼‰

### v4.0 å¢å¼ºåŠŸèƒ½
- **ä¼ é€’æ€§æŒ‡é’ˆåˆ«ååˆ†æ**: å¤šè½®è¿­ä»£ä¼ æ’­åˆ«åå…³ç³»ï¼Œå¤„ç†é—´æ¥åˆ«å
- **å¤šå±‚æŒ‡é’ˆæ”¯æŒ**: æ­£ç¡®å¤„ç† `**p`ã€`***p` ç­‰å¤æ‚æŒ‡é’ˆé“¾
- **ç»“æ„ä½“å­—æ®µè¿½è¸ª**: å­—æ®µçº§åˆ«çš„ç²¾ç¡®æ•°æ®æµåˆ†æ
- **å‡½æ•°å‰¯ä½œç”¨åˆ†æ**: è¯†åˆ«å‡½æ•°é€šè¿‡æŒ‡é’ˆå‚æ•°çš„éšå¼ä¿®æ”¹
- **é€’å½’è°ƒç”¨æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«é€’å½’å‡½æ•°ï¼Œé¿å…æ— é™è¿½è¸ª
- **ç±»å‹ä¿¡æ¯æå–**: åŸºæœ¬ç±»å‹ã€æŒ‡é’ˆå±‚çº§ã€ç»“æ„ä½“å­—æ®µ
- **æ•°ç»„è®¿é—®è¿½è¸ª**: ç»Ÿä¸€å¤„ç†æ•°ç»„è¯»å†™æ“ä½œ
- **å‡½æ•°è°ƒç”¨å›¾**: è‡ªåŠ¨æ„å»ºå‡½æ•°é—´çš„è°ƒç”¨å…³ç³»

### å¯é…ç½®é€‰é¡¹
- å¯ç”¨/ç¦ç”¨è¿‡ç¨‹é—´åˆ†æ
- è®¾ç½®å‡½æ•°è°ƒç”¨è¿½è¸ªæ·±åº¦
- è‡ªå®šä¹‰è¾“å…¥/è¾“å‡ºè·¯å¾„

## ä¸ Joern çš„å¯¹æ¯”

| ç‰¹æ€§ | æœ¬å·¥å…· v4.0 | Joern |
|------|------------|-------|
| åˆ†æèŒƒå›´ | å•æ–‡ä»¶ã€å¢å¼ºè·¨å‡½æ•° | å…¨ç¨‹åºã€å®Œæ•´è·¨å‡½æ•° |
| ä½œç”¨åŸŸåˆ†æ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| æŒ‡é’ˆåˆ«ååˆ†æ | âœ… ä¼ é€’æ€§ã€å¤šå±‚ã€å­—æ®µ | âœ… å®Œæ•´ï¼ˆæµæ•æ„Ÿï¼‰ |
| å‡½æ•°é—´åˆ†æ | âœ… å…¨å±€ã€è¿”å›ã€å‰¯ä½œç”¨ | âœ… å®Œæ•´ |
| é€’å½’æ£€æµ‹ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| ç±»å‹ç³»ç»Ÿ | âœ… åŸºç¡€ | âœ… å®Œæ•´ |
| ç»“æ„ä½“å­—æ®µ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å‡½æ•°æŒ‡é’ˆ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| è·¨æ–‡ä»¶åˆ†æ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| éƒ¨ç½²éš¾åº¦ | â­ ç®€å• | â­â­â­ å¤æ‚ |
| å¤„ç†é€Ÿåº¦ | âš¡ å¿«é€Ÿ | ğŸ¢ è¾ƒæ…¢ |
| é€‚ç”¨åœºæ™¯ | æ‰¹é‡å¤„ç†ã€å¿«é€ŸåŸå‹ | æ·±åº¦åˆ†æã€ç ”ç©¶ |

**ç²¾åº¦è¯„ä¼°**ï¼š
- å•å‡½æ•°å†…ï¼š**~90%** æ¥è¿‘ Joern
- è·¨å‡½æ•°ï¼š**~75%** æ¥è¿‘ Joernï¼ˆå…¨å±€ã€è¿”å›ã€å‰¯ä½œç”¨ï¼‰
- æŒ‡é’ˆåˆ†æï¼š**~70%** æ¥è¿‘ Joernï¼ˆä¼ é€’æ€§åˆ«åï¼‰

è¯¦ç»†å¯¹æ¯”è§ [IMPROVEMENTS.md](IMPROVEMENTS.md)ã€‚

## å®‰è£…

```bash
pip install -r requirements.txt
```

## ä½¿ç”¨

### 1. æ‰¹é‡åˆ†æ

```bash
# é»˜è®¤é…ç½®ï¼ˆæ¨èï¼‰ï¼šå¯ç”¨è¿‡ç¨‹é—´åˆ†æï¼Œæ·±åº¦=1
python slice_analyzer.py

# ç¦ç”¨è¿‡ç¨‹é—´åˆ†æï¼ˆä»…å‡½æ•°å†…åˆ‡ç‰‡ï¼‰
python slice_analyzer.py --no-interprocedural

# è®¾ç½®è°ƒç”¨æ·±åº¦
python slice_analyzer.py --max-call-depth 2

# è‡ªå®šä¹‰è¾“å…¥è¾“å‡º
python slice_analyzer.py --data-file input/data.json --output-dir output
```

å¤„ç† `input/data.json` ä¸­çš„æ‰€æœ‰æ ·æœ¬ã€‚

### 2. å•æ–‡ä»¶åˆ†æ

```bash
# é»˜è®¤é…ç½®
python slice_single.py <file_path> <line_number>

# ç¦ç”¨è¿‡ç¨‹é—´åˆ†æ
python slice_single.py <file_path> <line_number> --no-interprocedural

# è®¾ç½®è°ƒç”¨æ·±åº¦
python slice_single.py <file_path> <line_number> --max-call-depth 2
```

ç¤ºä¾‹ï¼š
```bash
python slice_single.py input/repository/vim-9.1.1896/src/netbeans.c 2292
```

### 3. å¯¹æ¯”åˆ†æ

```bash
python compare_results.py \
  output/slice_results_intraprocedural.json \
  output/slice_results_interprocedural.json \
  'å‡½æ•°å†…åˆ‡ç‰‡' 'è·¨å‡½æ•°åˆ‡ç‰‡'
```

### 4. å¯è§†åŒ–ç»“æœ

```bash
# æ˜¾ç¤ºå‰3ä¸ªç»“æœï¼Œä¸Šä¸‹æ–‡2è¡Œ
python visualize_slice.py

# è‡ªå®šä¹‰å‚æ•°
python visualize_slice.py output/slice_results.json 5 10
```

### 5. ç»Ÿè®¡åˆ†æ

```bash
python analyze_results.py
```

## è¾“å…¥æ ¼å¼

`input/data.json` ç¤ºä¾‹ï¼š

```json
[
  {
    "é¡¹ç›®å(å¸¦ç‰ˆæœ¬)": "vim-9.1.1896",
    "ç¼ºé™·æ‰€å±æ–‡ä»¶": "src/netbeans.c",
    "ç¼ºé™·è¡Œ": 2292
  }
]
```

## è¾“å‡ºæ ¼å¼

```json
{
  "target_line": 2292,
  "target_file": "input/repository/vim-9.1.1896/src/netbeans.c",
  "anchors": ["save_str", "strtok"],
  "slice_lines": [2291, 2292, 2298, 2329, 2330, 2331],
  "function_map": {
    "2291": "special_keys",
    "2292": "special_keys"
  },
  "config": {
    "interprocedural": true,
    "max_call_depth": 1
  }
}
```

## é…ç½®å»ºè®®

| åœºæ™¯ | é…ç½® | è¯´æ˜ |
|------|------|------|
| å¿«é€Ÿæ‰¹å¤„ç† | `--no-interprocedural` | æœ€å¿«ï¼Œä»…å‡½æ•°å†… |
| æ ‡å‡†åˆ†æï¼ˆæ¨èï¼‰ | é»˜è®¤ | å¹³è¡¡ç²¾åº¦å’Œæ€§èƒ½ |
| æ·±åº¦åˆ†æ | `--max-call-depth 2` | æ›´é«˜ç²¾åº¦ï¼Œè¾ƒæ…¢ |

## ä»£ç é‡æ„åŠŸèƒ½ ğŸ†•

### å¿«é€Ÿå¼€å§‹
```bash
# å•æ–‡ä»¶åˆ‡ç‰‡ + é‡æ„
python3 slice_with_reconstruction.py \
    --file test_v4_features.c \
    --line 50 \
    --output output/result.json

# æ‰¹é‡å¤„ç†æ•°æ®é›†
python3 slice_with_reconstruction.py \
    --data-file input/data.json \
    --output result.json

# éªŒè¯è¯­æ³•
python3 validate_syntax.py --result-file result.json
```

### é‡æ„ç‰¹æ€§
- âœ… **è¯­æ³•æ­£ç¡®**ï¼šç”Ÿæˆå¯è¢« C/C++ è§£æå™¨è§£æçš„ä»£ç 
- âœ… **å‡½æ•°éª¨æ¶**ï¼šå®Œæ•´ä¿ç•™å‡½æ•°ç­¾åå’Œç»“æ„
- âœ… **å˜é‡å£°æ˜**ï¼šè‡ªåŠ¨è¡¥å…¨ç¼ºå¤±çš„å£°æ˜
- âœ… **æ§åˆ¶ç»“æ„**ï¼šä¿ç•™ if/while/for ç­‰éª¨æ¶
- âœ… **æ ¼å¼åŒ–**ï¼šè‡ªåŠ¨ç¼©è¿›å’Œè¡Œå·æ³¨é‡Š
- âœ… **å®Œæ•´è¾“å‡º**ï¼šJSON æ ¼å¼åŒ…å«åˆ‡ç‰‡ä¿¡æ¯ + é‡æ„ä»£ç  + åˆ†æè¯¦æƒ…

### è¾“å‡ºç¤ºä¾‹
é‡æ„åçš„ä»£ç åŒ…å«ï¼š
- å¿…è¦çš„å¤´æ–‡ä»¶ï¼ˆstdio.h, stdlib.h, string.hï¼‰
- å…¨å±€å˜é‡å’Œç»“æ„ä½“å®šä¹‰
- å®Œæ•´çš„å‡½æ•°éª¨æ¶å’Œåˆ‡ç‰‡ä»£ç 
- åŸå§‹è¡Œå·æ³¨é‡Š

è¯¦è§ [USAGE_GUIDE.md](USAGE_GUIDE.md)

## å·¥å…·é›†

### ä¸»è¦å·¥å…·
- `slice_analyzer.py` - è¯­ä¹‰åˆ‡ç‰‡åˆ†æå™¨
- `slice_reconstructor.py` - ä»£ç é‡æ„å™¨ ğŸ†•
- `slice_with_reconstruction.py` - é›†æˆå¤„ç†å·¥å…· ğŸ†•
- `slice_single.py` - å•æ–‡ä»¶åˆ‡ç‰‡

### è¾…åŠ©å·¥å…·
- `check_results.py` - ç»“æœç»Ÿè®¡å’ŒæŸ¥çœ‹ ğŸ†•
- `validate_syntax.py` - è¯­æ³•éªŒè¯ ğŸ†•
- `visualize_slice.py` - åˆ‡ç‰‡å¯è§†åŒ–
- `analyze_results.py` - ç»Ÿè®¡åˆ†æ
- `compare_results.py` - ç»“æœå¯¹æ¯”
- `test_v4.py` - æµ‹è¯•å¥—ä»¶

## æ”¹è¿›å†å²

- **v4.0** (2024): ä»£ç é‡æ„åŠŸèƒ½ï¼Œä¼ é€’æ€§æŒ‡é’ˆåˆ†æï¼Œå‡½æ•°å‰¯ä½œç”¨åˆ†æ
- **v3.0** (2025-12-19): æŒ‡é’ˆå’Œè·¨å‡½æ•°åˆ†æ
- **v2.0** (2025-12-19): ä½œç”¨åŸŸåˆ†æï¼Œæ¶ˆé™¤è·¨å‡½æ•°è¯¯æŠ¥
- **v1.0** (2025-12-19): åŸºç¡€åˆ‡ç‰‡åŠŸèƒ½

# C/C++ Semantic Slicer (è¯­ä¹‰åˆ‡ç‰‡å·¥å…·)

åŸºäº Tree-sitter çš„ C/C++ å•æ–‡ä»¶è¯­ä¹‰åˆ‡ç‰‡å·¥å…·ï¼Œæ”¯æŒè¿‡ç¨‹é—´åˆ†æã€æŒ‡é’ˆåˆ†æå’Œ**ä»£ç é‡æ„**ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. è¯­ä¹‰åˆ‡ç‰‡åˆ†æ
- âœ… æ•°æ®æµåˆ†æï¼ˆdef-use chainsï¼‰
- âœ… æ§åˆ¶æµåˆ†æï¼ˆæ§åˆ¶ä¾èµ–ï¼‰
- âœ… è¿‡ç¨‹é—´åˆ†æï¼ˆå‡½æ•°è°ƒç”¨ã€å‚æ•°ä¼ é€’ï¼‰
- âœ… æŒ‡é’ˆå’Œåˆ«ååˆ†æ
- âœ… ç»“æ„ä½“å­—æ®µè¿½è¸ª
- âœ… æ•°ç»„è®¿é—®åˆ†æ
- âœ… é€’å½’å‡½æ•°å¤„ç†

### 2. ä»£ç é‡æ„ ğŸ†•
- âœ… **å°†åˆ‡ç‰‡æ¢å¤ä¸ºè¯­æ³•æ­£ç¡®çš„ C/C++ ä»£ç **
- âœ… è‡ªåŠ¨è¡¥å…¨å˜é‡å£°æ˜
- âœ… ä¿ç•™å‡½æ•°éª¨æ¶å’Œæ§åˆ¶ç»“æ„
- âœ… ä¿®å¤è¡¨è¾¾å¼ä¸ºåˆæ³•å ä½
- âœ… æ·»åŠ è¡Œå·æ³¨é‡Šå’Œæ ¼å¼åŒ–
- âœ… ç”Ÿæˆå®Œæ•´çš„ JSON è¾“å‡º

### 3. æ‰¹é‡å¤„ç†
- âœ… æ”¯æŒæ•°æ®é›†æ‰¹é‡åˆ†æ
- âœ… å®Œæ•´çš„ç»“æœè¾“å‡ºï¼ˆåˆ‡ç‰‡ + é‡æ„ä»£ç  + åˆ†æä¿¡æ¯ï¼‰
- âœ… è¯­æ³•éªŒè¯å·¥å…·
- âœ… ç»Ÿè®¡å’Œå¯è§†åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### å•æ–‡ä»¶åˆ‡ç‰‡ + é‡æ„
```bash
# å¯¹å•ä¸ªæ–‡ä»¶çš„æŒ‡å®šè¡Œè¿›è¡Œåˆ‡ç‰‡å¹¶é‡æ„ä»£ç 
python3 slice_with_reconstruction.py \
    --file test_v4_features.c \
    --line 50 \
    --output output/result.json

# ç»“æœåŒ…å«ï¼š
# - output/result.json: å®Œæ•´åˆ‡ç‰‡ä¿¡æ¯ï¼ˆJSONï¼‰
# - output/result_reconstructed.c: é‡æ„åçš„ C ä»£ç 
```

### æ‰¹é‡å¤„ç†æ•°æ®é›†
```bash
# å¤„ç†æ•´ä¸ªæ•°æ®é›†
python3 slice_with_reconstruction.py \
    --data-file input/data.json \
    --output result.json

# é™åˆ¶å¤„ç†æ•°é‡ï¼ˆç”¨äºæµ‹è¯•ï¼‰
python3 slice_with_reconstruction.py \
    --data-file input/data.json \
    --output result.json \
    --max-samples 10
```

### éªŒè¯ç»“æœ
```bash
# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
python3 check_results.py

# éªŒè¯è¯­æ³•æ­£ç¡®æ€§
python3 validate_syntax.py --result-file result.json
```

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### é‡æ„å‰ï¼ˆåˆ‡ç‰‡ç»“æœï¼‰
```
åˆ‡ç‰‡è¡Œå·: [2291, 2292, 2298, 2299, 2300, ...]
å‡½æ•°æ˜ å°„: {"2291": "special_keys", "2292": "special_keys", ...}
```

### é‡æ„åï¼ˆè¯­æ³•æ­£ç¡®çš„ä»£ç ï¼‰
```c
/* Reconstructed slice - Syntax-correct but semantically incomplete */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void special_keys(void)
{
    char *save_str = nb_unquote(args, NULL);  // Line 2291
    char *tok = strtok(save_str, " ");        // Line 2292
    
    /* ... */
    
    while (tok != NULL)                       // Line 2298
    {
        int i = 0;
        if ((sep = strchr(tok, '-')) != NULL)
        {
            *sep = NUL;
            while (*tok)
            {
                switch (*tok)
                {
                    case 'A':
                    case 'M':
                    case 'C':
                    case 'S':
                        keybuf[i++] = *tok;
                        keybuf[i++] = '-';
                        break;
                }
                tok++;
            }
            tok++;
        }
        
        if (strlen(tok) + i < KEYBUFLEN)
        {
            strcpy(&keybuf[i], tok);
            vim_snprintf(cmdbuf, sizeof(cmdbuf),
                        "<silent><%s> :nbkey %s<CR>", keybuf, keybuf);
            do_map(MAPTYPE_MAP, (char_u *)cmdbuf, MODE_NORMAL, FALSE);
        }
        tok = strtok(NULL, " ");
    }
    vim_free(save_str);
}
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
semantic-slicer/
â”œâ”€â”€ README.md
â”œâ”€â”€ RELEASE_v4.0.md
â”œâ”€â”€ IMPROVEMENTS.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ slice_analyzer.py
â”œâ”€â”€ slice_single.py
â”œâ”€â”€ compare_results.py
â”œâ”€â”€ visualize_slice.py
â”œâ”€â”€ analyze_results.py
â”œâ”€â”€ check_results.py
â”œâ”€â”€ validate_syntax.py
â”œâ”€â”€ input/
â”‚   â””â”€â”€ data.json
â””â”€â”€ output/
    â”œâ”€â”€ slice_results.json
    â”œâ”€â”€ slice_results_intraprocedural.json
    â”œâ”€â”€ slice_results_interprocedural.json
    â”œâ”€â”€ result.json
    â””â”€â”€ result_reconstructed.c
```
